<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Functional blocks | Standard Covoiturage</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="The &amp;#34;standard covoiturage&amp;#34; is intended to describe reference methods for making data available, carrying out transactions and, more generally, enabling the exchange of services between carpooling operators and MaaS platforms.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/standard-covoiturage/assets/css/0.styles.9248ae60.css" as="style"><link rel="preload" href="/standard-covoiturage/assets/js/app.bbb2d0fd.js" as="script"><link rel="preload" href="/standard-covoiturage/assets/js/2.90049311.js" as="script"><link rel="preload" href="/standard-covoiturage/assets/js/12.61e9daef.js" as="script"><link rel="prefetch" href="/standard-covoiturage/assets/js/10.e829d41f.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/11.6c3726b0.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/13.1f5c303d.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/14.ab05f61e.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/15.a67b706a.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/3.5cb8b966.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/4.02e2c2ac.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/5.040decdc.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/6.06438485.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/7.03c59953.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/8.3d31a9ef.js"><link rel="prefetch" href="/standard-covoiturage/assets/js/9.80032809.js">
    <link rel="stylesheet" href="/standard-covoiturage/assets/css/0.styles.9248ae60.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/standard-covoiturage/" class="home-link router-link-active"><!----> <span class="site-name">Standard Covoiturage</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/fabmob/standard-covoiturage" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub repository
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://fabmob.github.io/standard-covoiturage/specification.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  OpenAPI specification
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/fabmob/standard-covoiturage" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub repository
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://fabmob.github.io/standard-covoiturage/specification.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  OpenAPI specification
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/standard-covoiturage/" aria-current="page" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/standard-covoiturage/#goals" class="sidebar-link">Goals</a></li><li class="sidebar-sub-header"><a href="/standard-covoiturage/#drafts-and-final-versions" class="sidebar-link">Drafts and final versions</a></li><li class="sidebar-sub-header"><a href="/standard-covoiturage/#functional-perimeter" class="sidebar-link">Functional perimeter</a></li><li class="sidebar-sub-header"><a href="/standard-covoiturage/#standard-compliance" class="sidebar-link">Standard compliance</a></li></ul></li><li><a href="/standard-covoiturage/search.html" class="sidebar-link">Search</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/standard-covoiturage/search.html#search-for-single-journeys" class="sidebar-link">Search for single journeys</a></li><li class="sidebar-sub-header"><a href="/standard-covoiturage/search.html#search-for-regular-trips-and-associated-journeys" class="sidebar-link">Search for regular trips and associated journeys</a></li></ul></li><li><a href="/standard-covoiturage/booking.html" class="sidebar-link">Booking</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/standard-covoiturage/booking.html#integrated-booking-by-api" class="sidebar-link">Integrated booking by API</a></li><li class="sidebar-sub-header"><a href="/standard-covoiturage/booking.html#delegated-booking-by-deep-link" class="sidebar-link">Delegated booking by deep link</a></li></ul></li><li><a href="/standard-covoiturage/authentication.html" class="sidebar-link">Authentication across platforms (&quot;MaaS Connect&quot;)</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="functional-blocks"><a href="#functional-blocks" class="header-anchor">#</a> Functional blocks</h1> <h2 id="_2-normative"><a href="#_2-normative" class="header-anchor">#</a> 2. Normative</h2> <p>The first draft versions of this specification do not include normative parts.</p> <h2 id="_3-informative"><a href="#_3-informative" class="header-anchor">#</a> 3. Informative</h2> <h3 id="_3-2-booking"><a href="#_3-2-booking" class="header-anchor">#</a> 3.2. Booking</h3> <p>This specifications provides two flows for implementing an initial booking
transaction :</p> <ul><li>Integrated booking by API: the initial booking is handled by an API exchange
between MaaS platforms and operators. Users stay on their original
application, without having to switch to another, and they don't need to be
authenticated with the carpooling operator.</li> <li>Delegated booking by deep link: booking is handled by switching
applications, with a deep link to access directly to the right page on the
carpooling operator application. The user needs to authenticate with the
carpooling operator.</li></ul> <p>MaaS platforms and carpooling operators MUST support at least one of these two
flows if they implement booking. They MAY implement both.</p> <h4 id="_3-2-1-flow-independent-specifications"><a href="#_3-2-1-flow-independent-specifications" class="header-anchor">#</a> 3.2.1. Flow independent specifications</h4> <p>Both flows share a common pattern: a <code>*Booking</code> object with unique
<code>booking_id</code> is shared between the MaaS platform and the carsharing operator,
and its status is subsequently updated (some details of this object may differ
depending on the flow).  However, these operations are performed differently
depending on the selected booking flow.</p> <p>All information of a <code>Booking</code> object apart from its <code>status</code> attribute are
definitely fixed at creation. For both flows, if any information apart from
<code>status</code> needs to be changed, the carsharing operator or MaaS platform MUST
create a new <code>Booking</code> with a new <code>booking_id</code>, and MUST update the status of
the former booking to &quot;CANCELLED&quot;.</p> <p>For both flows, a status change MUST update the <code>status</code> to a subsequent
status respecting the following order: [ WAITING_CONFIRMATION, CONFIRMED,<br>
COMPLETED_PENDING_VALIDATION, VALIDATED, CANCELLED ]. <code>status</code> update requests
that do not comply with this rule SHOULD be dismissed (they may be the result
of an order of receipt different from that of the requests sending).</p> <h4 id="_3-2-2-integrated-booking-by-api"><a href="#_3-2-2-integrated-booking-by-api" class="header-anchor">#</a> 3.2.2. Integrated booking by API</h4> <p>Integrated booking by API is based on 3 routes described in the <a href="standard-covoiturage_openapi.yaml">OpenAPI
specification</a> :</p> <ul><li>POST /bookings : initialize the booking request</li> <li>PATCH /bookings : modify the state of the booking status to complete the booking flow</li> <li>GET /bookings/{bookingId} : get the state of the booking</li></ul> <h4 id="_3-2-3-delegated-booking-by-deep-link"><a href="#_3-2-3-delegated-booking-by-deep-link" class="header-anchor">#</a> 3.2.3. Delegated booking by deep link</h4> <p>This section provides precise guidelines for a carpooling operator and a MaaS
platform to implement a &quot;booking&quot; flow for passengers with deep linking, in
addition to the above flow independent specifications.</p> <p>There is no specific API endpoint associated to this flow, but the MaaS
platform that wishes to retrieve the booking information SHOULD implement the
booking feed functional block. In this case, the carpooling operator MUST
comply to the booking feed specification.</p> <h5 id="redirection-towards-the-carsharing-operator"><a href="#redirection-towards-the-carsharing-operator" class="header-anchor">#</a> Redirection towards the carsharing operator</h5> <p>The carpooling operator supporting deep linking MUST provide for each <code>Journey</code>
shared with the MaaS platform an attribute <code>webUrl</code>, with the full URL (with
all needed parameters) for the user's device to redirect the passenger from
the app of the MaaS platform to the operator's app or website.</p> <p>The booking flow with a deep link is initiated by the MaaS platform with a
<code>Journey</code> object provided by a carpooling operator (e.g. as a result of a
previous search). To do that, it MUST redirect the user to the deep link
contained in the
<a href="https://github.com/fabmob/standard-covoiturage/pull/2/files#diff-c722233128f788ea06650bffef56e418732898441b4e2199997c40e9070e3345R269" target="_blank" rel="noopener noreferrer">webUrl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
parameter of the
<a href="https://github.com/fabmob/standard-covoiturage/pull/2/files#diff-c722233128f788ea06650bffef56e418732898441b4e2199997c40e9070e3345R220" target="_blank" rel="noopener noreferrer">Journey<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
object.</p> <p>If the operator is providing an app (and not a website), one obstacle to
redirecting the passenger is whether they have the operator's app already
installed in their mobile device or not. If not, the deep link URL SHOULD be
capable of redirecting the passenger to the corresponding store instead. At
the operator's discretion, this URL can also temporarily store the URL
parameters for later retrieval. There are third-party services as well that
can provide such a solution. This way, after the app is installed, the
parameters can be recovered to automatically redirect the passenger to the
booking flow as if the app had always been installed.</p> <p>If the operator provides a website or if its app was already installed, then
following the deep link SHOULD automatically and seamlessly redirect the
passenger to the operator's booking flow. It is up to the operator to decide
where to start this flow and what to do with the parameters sent to the MaaS
app in the search to provide the passenger with the best booking experience.</p> <p>It is up to the passenger to decide whether to book the journey, any other
journey or none.</p> <p>If the passenger decides not to book the journey being displayed (or if is not
available anymore), the operator MAY provide the means for the passenger to go
back to the search results on the MaaS app. It is then up to the passenger to
decide whether to select another result and repeat the above process. If they
decide to book it, it is at the operator's discretion to decide how to
continue guiding the passenger through the booking process.</p> <div class="language-mermaid extra-class"><pre class="language-mermaid"><code><span class="token keyword">flowchart</span> LR
    A<span class="token text string">[Display trip&lt;br&gt;results&lt;br&gt;on MaaS]</span> <span class="token arrow operator">--&gt;</span><span class="token label property">|Passenger clicks&lt;br&gt;on result|</span> B<span class="token text string">{Is operator app &lt;br/&gt;installed?}</span>
    B <span class="token arrow operator">--&gt;</span><span class="token label property">|Yes|</span> D
    B <span class="token arrow operator">--&gt;</span><span class="token label property">|No|</span> K<span class="token text string">[&quot;Redirect to store&lt;br&gt;(Search parameters&lt;br&gt;are preserved)&quot;]</span>
    K <span class="token arrow operator">--&gt;</span><span class="token label property">|App installed|</span> D<span class="token text string">[Display&lt;br&gt;trip details]</span>
    D <span class="token arrow operator">--&gt;</span> E<span class="token text string">{Passenger&lt;br&gt;booked&lt;br&gt;trip?}</span>
    E <span class="token arrow operator">-.-&gt;</span><span class="token label property">|&quot;No, back to results&quot;|</span> A
    E <span class="token arrow operator">-.-&gt;</span> <span class="token label property">|Yes|</span> F<span class="token text string">[Operator sends&lt;br&gt;booking details&lt;br&gt;to MaaS]</span>
    F <span class="token arrow operator">-.-&gt;</span> <span class="token label property">|Back to MaaS|</span> G<span class="token text string">((Display trip&lt;br&gt;booked))</span>
</code></pre></div><h4 id="_3-2-4-booking-information-push-from-carsharing-operator-to-maas-platform-booking-feed-flow"><a href="#_3-2-4-booking-information-push-from-carsharing-operator-to-maas-platform-booking-feed-flow" class="header-anchor">#</a> 3.2.4. Booking information push from carsharing operator to MaaS platform (booking feed flow)</h4> <p>The booking feed is the channel by which the carpooling operator sends
information to the MaaS platform, about the booking events happening on the
carpooling operator website or app. The booking feed mechanism relies on an
<a href="https://openid.net/specs/openid-connect-core-1_0.html" target="_blank" rel="noopener noreferrer">Open ID Connect 1.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
identity layer where the Provider is the MaaS platform, subsequently referred
to as &quot;MaaS connect&quot;. See <a href="#33-authentication-across-platforms-maas-connect">the dedicated
section</a> for further
information. This section adds up to the above flow independent
specifications.</p> <p>The MaaS platform needs to implement the following endpoint:</p> <ul><li><code>POST /booking_events</code></li></ul> <p>A carpooling operator offering booking by deep link MUST accept authentication
via &quot;MaaS connect&quot;.</p> <p>A MaaS platform SHOULD provide a &quot;MaaS Connect&quot; identity layer in order to get
back information on booking events happening on the platform of the transport
operator. In that case, it also MUST provide an API endpoint matching the
<code>POST /booking_events</code> specification. Moreover, the passenger MUST be
authenticated using MaaS Connect at the time of the redirection to allow the
booking feed.</p> <p>The booking feed flow starts as soon as a booking is created, regardless of
whether the trip was first consulted on the MaaS app. It sends booking data to
the MaaS platform. It allows the MaaS platform to support use-cases for which
booking data need to be instantly available (real-time reporting, incentive
program, pricing bundles,...).</p> <p>If the MaaS platform is offering the <code>POST /booking_events</code> endpoint, and once
a booking is created, the operator MUST send the booking details to the MaaS
platform. The operator MUST also notify every <code>status</code> update of the booking
to the MaaS plateform. As specified in <a href="#32-booking">the introduction of the booking
section</a>, every other change MUST be operated by creating a new <code>Booking</code>
object and udating the <code>status</code> of the former booking to &quot;CANCELLED&quot;.</p> <p>A status update with the <code>POST /booking_events</code> endpoint MUST repeat the whole
<code>Booking</code> object each time as redunduncy allows for a better resilience to
communication failures (e.g. a status update event can be processed even if
the booking creation event has been missed).</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/standard-covoiturage/assets/js/app.bbb2d0fd.js" defer></script><script src="/standard-covoiturage/assets/js/2.90049311.js" defer></script><script src="/standard-covoiturage/assets/js/12.61e9daef.js" defer></script>
  </body>
</html>
